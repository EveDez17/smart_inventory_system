{% extends "users/base.html" %}
{% load static %}

{% block extrahead %}
<style>
  html, body {
    height: 100%;
    margin: 0;
    background-image: url('{% static 'images/login.jpg' %}');
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    background-attachment: fixed;
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/vue@2.6.12/dist/vue.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<link href="{% static 'css/gatehouse.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
<div id="vue-app" class="container mt-5">
  <h2 class="text-center mb-4">Book Gatehouse Entry | Smart Inventory System</h2>
  <div class="card">
    <div class="card-body">
      <form @submit.prevent="submitForm">
        {% csrf_token %}
        <input type="text" v-model="newBooking.company" class="form-control" placeholder="Company">
        <input type="text" v-model="newBooking.vehicle_registration" class="form-control" placeholder="Vehicle Registration">
        <input type="text" v-model="newBooking.trailer_number" class="form-control" placeholder="Trailer Number">
        <input type="datetime-local" v-model="newBooking.arrival_time" class="form-control" placeholder="Arrival Time">
        <div class="form-check mt-3">
          <input type="checkbox" v-model="newBooking.has_paperwork" class="form-check-input" id="has_paperwork">
          <label for="has_paperwork" class="form-check-label">Has Paperwork</label>
        </div>
        <input type="text" v-if="newBooking.has_paperwork" v-model="newBooking.paperwork_description" class="form-control mt-3" placeholder="Paperwork Description">
        <div class="text-center mt-4">
          <button type="submit" class="btn btn-primary">Register</button>
        </div>
      </form>
    </div>
    <div class="mb-3 text-center">
      <a href="{% url 'inbound:gatehouse-bookings-list' %}" class="btn btn-info">View Gatehouse Bookings</a>
    </div>
  </div>


  <!-- Component to list the gatehouse bookings -->
  <gatehouse-bookings-list></gatehouse-bookings-list>
</div>

<script>
// CSRF Token for POST requests
axios.defaults.headers.common['X-CSRFToken'] = '{{ csrf_token }}';

// Vue component for gatehouse bookings list
Vue.component('gatehouse-bookings-list', {
  data: function () {
    return {
      bookings: [],
    }
  },
  created() {
    this.fetchBookings();
  },
  methods: {
    fetchBookings() {
      axios.get('/api/gatehouse-bookings/')
        .then(response => {
          this.bookings = response.data;
        })
        .catch(error => {
          console.error('Error fetching the bookings:', error);
        });
    },
    updateBooking(bookingId) {
      // Handle booking update
    },
    cancelBooking(bookingId) {
      if (confirm('Are you sure you want to cancel this booking?')) {
        // Here you'd make an API call to your backend to update the booking as cancelled.
        // This is an example. You'll need to adjust it to your backend implementation.
        axios.put(`/api/gatehouse-bookings/${bookingId}/cancel/`)
          .then(() => {
            // Update the booking in the local list to reflect the cancellation
            const booking = this.bookings.find(b => b.id === bookingId);
            if (booking) {
              booking.cancelled = true;
            }
            console.log('Booking cancelled successfully');
          })
          .catch(error => {
            console.error('Error cancelling the booking:', error);
          });
      }
    },
    deleteBooking(bookingId) {
      if (confirm('Are you sure you want to delete this booking?')) {
        axios.delete(`/api/gatehouse-bookings/${bookingId}/`)
          .then(() => {
            this.bookings = this.bookings.filter(booking => booking.id !== bookingId);
            console.log('Booking deleted successfully');
          })
          .catch(error => {
            console.error('Error deleting the booking:', error);
          });
        },
        updateBooking(bookingId, updatedBooking) {
          axios.put(`/api/gatehouse-bookings/${bookingId}/`, updatedBooking)
            .then(response => {
              const index = this.bookings.findIndex(booking => booking.id === bookingId);
              if (index !== -1) {
                this.$set(this.bookings, index, response.data);
                console.log('Booking updated successfully');
              }
            })
            .catch(error => {
              console.error('There was an error updating the booking:', error);
            });
        },
        deleteBooking(bookingId) {
          axios.delete(`/api/gatehouse-bookings/${bookingId}/`)
            .then(() => {
              this.bookings = this.bookings.filter(booking => booking.id !== bookingId);
              console.log('Booking deleted successfully');
            })
            .catch(error => {
              console.error('There was an error deleting the booking:', error);
            });
        }
      }
    }
  },
  template: `
  template: `
  <div>
    <h2 class="text-center mb-4">Gatehouse Bookings</h2>
    <div class="list-group">
      <a href="#" class="list-group-item list-group-item-action" 
         v-for="booking in bookings" :key="booking.id">
        <h5 class="mb-1">{{ booking.driver_name }}</h5>
        <p class="mb-1">Company: {{ booking.company }}</p>
        <p class="mb-1">Vehicle Registration: {{ booking.vehicle_registration }}</p>
        <small>Arrival Time: {{ new Date(booking.arrival_time).toLocaleString() }}</small>
        <button @click="updateBooking(booking.id)" class="btn btn-secondary btn-sm">Update</button>
        <button @click="cancelBooking(booking.id)" class="btn btn-warning btn-sm">Cancel</button>
        <button @click="deleteBooking(booking.id)" class="btn btn-danger btn-sm">Delete</button>
      </a>
    </div>
  </div>
  
  new Vue({
    el: '#vue-app',
    data: {
      newBooking: {
        driver_name: '',
        company: '',
        vehicle_registration: '',
        trailer_number: '',
        arrival_time: '',
        has_paperwork: false,
        paperwork_description: ''
      }
    },
    methods: {
      submitForm() {
        axios.post('/api/gatehouse-bookings/', this.newBooking)
          .then(response => {
            this.bookings.push(response.data);
            console.log('Booking created successfully');
            // Reset the form
            this.newBooking = {
              driver_name: '',
              company: '',
              vehicle_registration: '',
              trailer_number: '',
              arrival_time: '',
              has_paperwork: false,
              paperwork_description: ''
            };
          })
          .catch(error => {
            console.error('Error creating booking:', error.response.data);
          });
      }
    }
  });
  </script>
  {% endblock %}
  







